<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 16px; }
    .comparison-table {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow-x: auto;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #f3f4f6;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: sticky;
      top: 0;
    }
    td {
      font-size: 14px;
    }
    .metric-label {
      font-weight: 600;
      color: #374151;
    }
    .fund-header {
      font-weight: 600;
      color: #111827;
      font-size: 14px;
    }
    .fund-code {
      font-size: 12px;
      color: #6b7280;
      font-family: monospace;
      display: block;
      margin-top: 2px;
    }
    .positive { color: #059669; font-weight: 600; }
    .negative { color: #dc2626; font-weight: 600; }
    .best { background: #d1fae5; }
  </style>
</head>
<body>
  <div class="comparison-table">
    <table id="comparisonTable">
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const { funds } = window.openai.toolOutput._meta;

    // Build header
    const headerRow = document.getElementById('headerRow');
    headerRow.innerHTML = '<th>Metric</th>';
    funds.forEach(fund => {
      headerRow.innerHTML += `
        <th>
          <div class="fund-header">${fund.fund_name || 'N/A'}</div>
          <span class="fund-code">${fund.symbol || 'N/A'}</span>
        </th>
      `;
    });

    // Metrics to compare
    const metrics = [
      { label: 'NAV', key: 'nav_value', format: (v) => v ? parseFloat(v).toFixed(4) : 'N/A', compare: false },
      { label: 'YTD Return', key: 'performance.ytd', format: (v) => v !== null && v !== undefined ? parseFloat(v).toFixed(2) + '%' : 'N/A', compare: true },
      { label: '1Y Return', key: 'performance.1y', format: (v) => v !== null && v !== undefined ? parseFloat(v).toFixed(2) + '%' : 'N/A', compare: true },
      { label: '3Y Return', key: 'performance.3y', format: (v) => v !== null && v !== undefined ? parseFloat(v).toFixed(2) + '%' : 'N/A', compare: true },
      { label: '5Y Return', key: 'performance.5y', format: (v) => v !== null && v !== undefined ? parseFloat(v).toFixed(2) + '%' : 'N/A', compare: true },
      { label: 'Risk Level', key: 'risk_level', format: (v) => v || 'N/A', compare: false },
      { label: 'AMC', key: 'amc', format: (v) => v || 'N/A', compare: false },
    ];

    const getNestedValue = (obj, path) => {
      return path.split('.').reduce((o, p) => o && o[p], obj);
    };

    const tableBody = document.getElementById('tableBody');
    metrics.forEach(({ label, key, format, compare }) => {
      let row = `<tr><td class="metric-label">${label}</td>`;

      const values = funds.map(fund => {
        const val = getNestedValue(fund, key);
        return val !== null && val !== undefined ? parseFloat(val) : null;
      });
      const maxValue = compare ? Math.max(...values.filter(v => v !== null && !isNaN(v))) : null;

      funds.forEach(fund => {
        const value = getNestedValue(fund, key);
        const numValue = value !== null && value !== undefined ? parseFloat(value) : null;
        const formatted = format(value);

        let className = '';
        if (compare && numValue !== null && !isNaN(numValue)) {
          className = numValue >= 0 ? 'positive' : 'negative';
          if (numValue === maxValue) className += ' best';
        }

        row += `<td class="${className}">${formatted}</td>`;
      });

      row += '</tr>';
      tableBody.innerHTML += row;
    });
  </script>
</body>
</html>

